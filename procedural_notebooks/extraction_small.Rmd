---
title: '`r paste("Extraction plan for ", params$first, "-", params$last, " on less than full plates",sep =
  "")`'
output:
  pdf_document: default
  html_document: default
date: '`r Sys.Date()`'
params:
  first: APCL18_649
  last: APCL18_732
---

This is a script for adding samples that are not in the laboratory database and have not been extracted. This small extraction script is for samples that will not fill 2 plates.  This script only can do one plate at a time so figure out the start and stop samples of a plate and go from there.

```{r echo=FALSE, message=FALSE}
source("../genomics/scripts/lab_helpers.R")
library(kableExtra)
```
####Obtain a list of all clownfish sample ids from the Leyte database ####
```{r}
# connect to leyte fieldwork db
leyte <- read_db("Leyte")
# import fish table
# select down to only sample_id numbers and remove any rows without a sample
fish <- leyte %>% tbl("clownfish") %>% 
  # select only the column sample_id
  select(sample_id) %>%             
  # remove any non-sample observations
  filter(!is.na(sample_id)) %>%     
  distinct(sample_id) %>%                         
  # remove any repeat sample_ids (this should not be needed)
  collect()

# make sure each sample_id is only represented once
fish <- distinct(fish)
```
####Select the range of samples in the plate
```{r}
# get a list of the sample ids that need to be extracted
work <- fish %>% 
  filter(sample_id >= params$first, sample_id <= params$last)

# define wells and make plate as small as work (less than 96)
plate <- data.frame(row = rep(LETTERS[1:8], 12), col = unlist(lapply(1:12, rep, 8))) %>% 
  mutate(sample_id = ifelse(row == "D" & col == 2, "XXXX", NA), 
    sample_id = ifelse(row == "E" & col == 8, "XXXX", sample_id)) %>% 
  slice(1:(nrow(work)+2))

sample_wells <- plate %>% 
  filter(is.na(sample_id)) %>% 
  select(-sample_id)

plate <- anti_join(plate, sample_wells, by = c("row", "col"))

sample_wells <- cbind(sample_wells, work)

plate <- rbind(plate, sample_wells) %>% 
  arrange(col, row)
```

####Make a plate map of sample IDs (for knowing where to place fin clips) ####
```{r message=FALSE}
platemap <- as.matrix(reshape2::acast(plate, plate$row ~ plate$col), value.var = plate$sample_id)
  knitr::kable(platemap, booktabs = T) %>% 
    # use scale_down to get map to fit within the bounds of the pdf
    kable_styling(latex_options = "scale_down")  
```
###ONLY DO THIS ONCE 
####Generate extract numbers for database
```{r}
lab <- read_db("Laboratory")
extracted <- lab %>% tbl("extraction") %>% 
  summarise(last = max(extraction_id, na.rm = T)) %>% 
  collect() %>% 
  mutate(last = substr(last, 2,5))

plate <- plate %>% 
  mutate(well = 1:nrow(plate)) %>% 
  mutate(extraction_id = paste("E", well + as.numeric(extracted$last), sep = "")) %>% 
  mutate(well = paste(row, col, sep = "")) %>% 
  mutate(method = "DNeasy96", 
    final_vol = "200")

plate_name <- plate %>% 
  summarise(first = min(extraction_id), 
    last = max(extraction_id, na.rm = T))
```

####Make a platemap with extraction ids
```{r}
map <- plate %>% 
  select(row, col, extraction_id)
platemap <- as.matrix(reshape2::acast(map, map$row ~ map$col), value.var = map$extraction_id)
knitr::kable(platemap, booktabs = T) %>% 
  kable_styling()

plate <- plate %>% 
  mutate(plate = paste(plate_name$first, plate_name$last, sep = "-")) %>% 
  select(-row, -col)
```
####Import the extract list into the database
#####Make sure you have created your output PDF for this labwork before sending to the database
```{r}
rm(lab)
lab <- write_db("Laboratory")
dbWriteTable(lab, "extraction", plate, row.names = F, overwrite = F, append = T)
dbDisconnect(lab)
rm(lab)
```



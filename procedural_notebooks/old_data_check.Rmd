---
title: "Checking old field data for type-os"
output: html_notebook
---

I copied and pasted the 01checkxl.R script from the field repository into this notebook.

```{r setup}
library(tidyverse)
library(stringr)
source("../genomics/scripts/field_helpers.R")
source("../genomics/scripts/lab_helpers.R")
```

check database data
```{r get data}
problem <- tibble()

leyte <- write_db("Leyte")

dive <- leyte %>% 
  tbl("diveinfo") %>% 
  collect()

anem <- leyte %>% 
  tbl("anemones") %>% 
  filter(dive_table_id %in% dive$dive_table_id) %>% 
  collect()

clown <- leyte %>% 
  tbl("clownfish") %>% 
  filter(anem_table_id %in% anem$anem_table_id) %>% 
  collect()

pit <- leyte %>% 
  tbl("pitscan") %>% 
  collect()
```



#   check the diveinfo ====
```{r dive check}
sites <- c("Palanas", "Wangag", "S. Magbangon", "N. Magbangon", "Cabatoan", "Caridad Cemetery", "Caridad Proper", "Hicgop", "Hicgop South", "Sitio Tugas", "Elementary School", "Sitio Lonas", "San Agustin", "Poroc San Flower", "Poroc Rose", "Visca", "Gabas", "Tamakin Dacot", "Haina", "Sitio Baybayon", "Pangasugan")

good <- filter(dive, site %in% sites)
bad <- anti_join(dive, good)
if (nrow(bad) > 0){
  bad$typeo <- "fix misspelled site"
  (problem <- rbind(problem, bad))
}
rm(good, bad)


```
#   check the clownfish
```{r clown check}
# check fish species
fish <- c("APCL", "APOC", "APPE", "APSE", "APFR", "APPO", "APTH", "PRBI", "NA")
good <- filter(clown, fish_spp %in% fish)
bad <- anti_join(clown, good)
bad <- filter(bad, !is.na(fish_spp), fish_spp != "")
if (nrow(bad) > 0){
  bad$typeo <- "fix fish spp on fish table"
  (problem <- rbind(problem, bad))
}
rm(good, bad)

# check tail colors
colors <- c("YE", "O", "YR", "YP", "Y", "W", "WR", "WP", "BW", "B")
good <- filter(clown, color %in% colors)
bad <- anti_join(clown, good)
bad <- filter(bad, !is.na(color), color != "")
if (nrow(bad) > 0){
  bad$typeo <- "fix tail color on fish table"
(problem <- rbind(problem, bad))
  }
rm(good, bad)

# does the anem_id in fish table match the anem_id in anem table?
# clowndive <- dive$dive_num
# clowndive <- unique(clowndive)
# bad <- compare_dives(clowndive)
# 
# if (nrow(bad) > 0){
#   bad$typeo <- "anemid in fish table doesn't match anem data table"
# }
# problem <- rbind(problem, bad)
# rm(bad, good)

# Are there repeat fin_ID numbers on the clownfish sheet? ####
bad <- clown %>% 
  filter(!is.na(sample_id)) %>% 
  group_by(sample_id) %>% 
  summarise(count = n()) %>% 
  filter(count > 1)
if (nrow(bad) > 0){
  bad$typeo <- "fin_id is repeated"
  (problem <- rbind(problem, bad))
}



# find samples that are lacking an anemone #### this needs to be added to problem - haven't tested -MRS
lack <- clown %>%
    filter(is.na(anem_table_id), !is.na(fish_spp))
# %>% 
  #   select(dive_num, obs_time, tag_id, fin_id, notes) %>% 
  #   filter(!is.na(fin_id) | !is.na(tag_id)))

# if this is zero,
rm(lack) # if it is not zero, look into what is going on on the data sheet

```


# check anem 
```{r anem check}
anems <- c("ENQD", "STME", "HECR", "HEMG", "STHD", "HEAR", "MADO", "HEMA", "STGI", "????", "EMPT")
good <- filter(anem, anem_spp %in% anems)
bad <- anti_join(anem, good)
bad <- bad %>% 
  filter(!is.na(anem_spp), anem_spp != "")
if (nrow(bad) > 0){
  bad$typeo <- "fix anem spp on anem table"
  (problem <- rbind(problem, bad))
}

rm(good, bad)


# are there anemones listed at a different site than they were in other years? 
# all anemones with anem_ids from all years
anem_db <- leyte %>% 
  tbl("anemones") %>% 
  select(anem_table_id, dive_table_id, anem_id) %>%
  filter(!is.na(anem_id), anem_id != "-9999", anem_id != "NULL") %>%
  collect()
# all dives for those anemones
dive_db <- leyte %>% 
  tbl("diveinfo") %>% 
  select(dive_table_id, site) %>% 
  collect() %>% 
  filter(dive_table_id %in% anem_db$dive_table_id)
  
  
anem_db <- left_join(anem_db, dive_db, by = "dive_table_id")
anem_site <- anem_db %>%
  select(anem_id, site) %>%
  distinct() 

# are any anem_ids at more than one site?
dups <- anem_site %>% 
  group_by(anem_id) %>% 
  summarise(num_sites = n()) %>% 
  filter(num_sites > 1)

# got 3 results
dup_site <- anem_db %>% 
  filter(anem_id %in% dups$anem_id)
# these are from the recent dive split that I did at Magbangon.
# Which is the correct site?
dup_dive <- leyte %>% 
  tbl("diveinfo") %>% 
  filter(dive_table_id %in% dup_site$dive_table_id) %>% 
  collect()

# is the same old_anem_id used for multiple anems?
  
double <- anem %>% 
  select(anem_id, anem_obs, old_anem_id) %>% 
  filter(!is.na(anem_id)) %>% 
  distinct() %>% 
  group_by(old_anem_id) %>% 
  summarise(count = n()) %>% 
  filter(count > 1)

dups <- anem %>% 
  select(anem_id, anem_obs, old_anem_id, anem_table_id, dive_table_id) %>% 
  filter(!is.na(anem_id), !is.na(old_anem_id)) %>% 
  filter(old_anem_id %in% double$old_anem_id) %>% 
  arrange(old_anem_id)

# pull in sites for dups
dups <- left_join(dups, select(dive, dive_table_id, site, date), by = "dive_table_id") %>% 
  arrange(old_anem_id)

```
Fix anem_obs for anems
```{r fix anem obs}
dat <- leyte %>% 
  tbl("anemones") %>% 
  collect()

change <- dat %>% 
  filter(anem_id == 2572) %>% 
  mutate(anem_obs = 50, 
    correction = "Y", 
    corr_date = "2018-10-09",
    corr_editor = "MRS", 
    corr_message = ifelse(is.na(corr_message), "changed anem_obs from 113 to 50 because both anem_id 434 and anem_id 2572 were recorded as having the old_anem_id 110", paste("changed anem_obs from 113 to 50 because both anem_id 434 and anem_id 2572 were recorded as having the old_anem_id 110", corr_date, corr_editor, corr_message, sep = ", ")))

dat <- change_rows(dat, change, "anem_table_id")

# dbWriteTable(leyte, "anemones", dat, overwrite = T, row.names = F)
    
```



Fix anemones that were observed during a dive that I just split
```{r fix split anem}
dat <- leyte %>% 
  tbl("anemones") %>% 
  collect()

change <- dat %>% 
  filter(anem_table_id >= 7661, anem_table_id <= 7675) %>% 
  mutate(dive_table_id = 588, 
    corr_message = ifelse(!is.na(corr_message), paste(corr_date, corr_editor, corr_message, sep = ", "), corr_message))

change <- change %>% 
  mutate(correction = "Y", 
    corr_date = "2018-10-09", 
    corr_editor = "MRS", 
    corr_message = ifelse(
      !is.na(corr_message), 
      "Changed dive_table_id from 324 to 588 because dive was split between N. and S. Magbangon.", 
      paste("Changed dive_table_id from 324 to 588 because dive was split between N. and S. Magbangon.", corr_message, sep = ", ")))

# remove rows
dat <- anti_join(dat, change, by = "anem_table_id")
dat <- rbind(dat, change)

# check for duplicated rows
dup <- dat %>%
  group_by(anem_table_id) %>% 
  summarise(n = n()) %>% 
  filter(n > 1)
#
# dbWriteTable(leyte, "anemones", dat, overwrite = T, row.names = F)
```


# are there missing anemone tag numbers on the clownfish sheet?  #### - begin with the starting anem number for this field season
  # gather the used ids
anem_ids <- clown %>% 
  select(anem_id) %>% 
  filter(!is.na(anem_id), anem_id != "") %>%
  distinct()

x <- c(2938:max(anem_ids$anem_id)) #2938 is the first anem_id for 2018
y <- data.frame(x) %>% 
  rename(anem_id = x) %>% 
  filter(anem_id != 3101, anem_id != 3015, anem_id != 2947, anem_id !=3168, anem_id != 3223, anem_id != 3239) # these tags were probably dropped

bad <- anti_join(y, anem_ids)
if (nrow(bad) > 0){
  bad <- bad %>% 
    mutate(typeo = "anem_id is missing", 
      fin_id = NA)
 problem <- mutate(problem, anem_id = NA)
}
(problem <- rbind(problem, bad))





# is an anemone observed more than once?
  obs_anem <- clown %>% 
    filter(!is.na(anem_spp)) %>% 
    group_by(anem_id) %>% 
    summarise(count = n()) %>% 
    filter(count > 1)

# is data in a weird place?
  misplaced <- clown %>% 
    filter(is.na(anem_spp), 
      !is.na(depth) | !is.na(gps) |
        !is.na(anem_dia) | !is.na(egg_height)) %>% 
    filter(!is.na(anem_id) & anem_spp != "EMPT")
  
  
  
    
  # someday when we want to separate multiple fish on one untagged anem to make it not look like multiple anems, can check if the time is the same for multiple fish (or is time the same for identical anems) - this won't work well because it will be hard to tell if it is more than one anem or one anem recorded several times.
  
  
# ---------------------------------------------
#   format pit scanner data
# ---------------------------------------------
pit <- from_scanner(pitfile) # should generate 4 parsing failures #AD note - only generated 3 parsing errors... but still produces 3 columns "scan", "date", "time"
old_pit <- from_scanner(oldpitfile)

#When ran 3/25/18, old_pit has a \ added to the end of each time - remove it below
old_pit$time <- str_sub(old_pit$time, 1, str_length(old_pit$time)-1)

pit <- rbind(pit, old_pit) #join scans from current pit scanner and first one together
rm(old_pit)

# find only this year - format of date should be 18-01-01 #AD note - date is actually formatted 01/01/16
pit <- filter(pit, substr(date, 1,2) == "18")
#pit <- filter(pit, substr(date, 7,8) == "18" | substr(date, 1,2) == "18") #placement of year changes throughout! but looks like the 4 with 7,8 position are repeated with 1,2 too

# get rid of test tags
pit <- filter(pit, substr(scan,1,3) != "989" & substr(scan,1,3) != "999")
pit <- arrange(pit, date, time)

# ---------------------------------------------
#   format tag ids on clownfish data sheet
# ---------------------------------------------
clown <- clown %>% 
  mutate(tag_id = stringr::str_replace(tag_id, "9851_", "985153000")) %>% 
  mutate(tag_id = stringr::str_replace(tag_id, "9861_", "986112100")) %>% 
  mutate(tag_id = stringr::str_replace(tag_id, "9820_", "982000411")) %>% 
  mutate(tag_id = stringr::str_replace(tag_id, "9821_", "982126052")) %>% # fix 6 digit entries
  mutate(tag_id = stringr::str_replace(tag_id, "^95", "98212605295"), 
    tag_id = stringr::str_replace(tag_id, "^818", "982000411818"),
    tag_id = stringr::str_replace(tag_id, "^1", "9861121001"),
    tag_id = stringr::str_replace(tag_id, "^3", "9851530003"),
    tag_id = stringr::str_replace(tag_id, "^4", "9851530004"),
    tag_id = stringr::str_replace(tag_id, "^6", "9821260526"))
    
    

tag_ids <- clown %>% select(tag_id, recap) %>% filter(!is.na(tag_id))

# ---------------------------------------------
#   compare scans to datasheets
# ---------------------------------------------

# What tags are in the spreadsheet that were not scanned by the scanner (type-os) - should return 0 rows
spreadsheet <- anti_join(tag_ids, pit, by = c("tag_id" = "scan"))
clown %>% 
  filter(tag_id %in% spreadsheet$tag_id) %>% 
  select(dive_num, obs_time, tag_id)

# if there are rows in spreadsheet, view pit and compare


# What tags are in the scanner that are not in spreadsheet (type-os) - should return 0 rows
anti_join(pit, tag_ids, by = c("scan" = "tag_id"))  
# 818456 was scanned but the fish escaped before they could be tagged so as of 2018-03-14  it has not been used yet.

# make sure that pit tags with N only occur once on the data sheet
multi <- tag_ids %>% 
  filter(recap == "N") %>% 
  group_by(tag_id) %>% 
  summarise(tag_count = n()) %>% 
  filter(tag_count > 1)

# if multi is not zero rows, there is a type-o in one of the rows for each tag listed, double check these. (the recent anti_join(pit, tag_ids) should have also flagged this)

# view any problems that need to be taken care of
problem




# testing ####
# # an anemone came back as being listed in both Caridad and Hicgop South. This anemone is definitely in Hicgop, looking into database to see when it was ever recorded in Caridad.
# load("data/db_backups/anemones_db.Rdata")
# weird <- anem %>% 
#   filter(anem_id == 305)
# weird$corr_message
# 
# # the correction message says changed anem_id from 15 to NULL but the anem_id is not NULL, it is 305.  Very weird.  Let's get the info to go back to the data sheet - ok, changed anem_obs, not anem_id.  Fixed in db
# 
# load("data/db_backups/diveinfo_db.Rdata")
# dive <- dive %>% 
#   filter(dive_table_id %in% weird$dive_table_id)


# # do we have any tags that are scanned as Y and only appear once - compare to db? - # Doesn't seem to be working as of 3/15/18; pulls out 986112100172598 and 986112100172301, both of which were scanned in 2017 when connect directly to database and check...
# load("data/fish_db.Rdata")
# 
# # what are past tags?
# db_tags <- fish_db %>% 
#   select(tag_id) 
# 
# # which tags were marked as recaptures this field season
# current_tags <- clown %>% 
#   filter(recap == "Y") %>% 
#   select(tag_id)
# 
# # are any of these tags not in the db already?
# missing <- anti_join(current_tags, db_tags)
# 

# should be 0 obs ####

# fish anems - vs anem obs

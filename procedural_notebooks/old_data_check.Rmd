---
title: "Checking old field data for type-os"
output: html_notebook
---

I copied and pasted the 01checkxl.R script from the field repository into this notebook.

```{r setup}
library(tidyverse)
library(stringr)
source("../genomics/scripts/field_helpers.R")
source("../genomics/scripts/lab_helpers.R")
```

check database data
```{r get data}
problem <- tibble()

leyte <- write_db("Leyte")

dive <- leyte %>% 
  tbl("diveinfo") %>% 
  collect()

anem <- leyte %>% 
  tbl("anemones") %>% 
  filter(dive_table_id %in% dive$dive_table_id) %>% 
  collect()

clown <- leyte %>% 
  tbl("clownfish") %>% 
  filter(anem_table_id %in% anem$anem_table_id) %>% 
  collect()

pit <- leyte %>% 
  tbl("pitscan") %>% 
  collect()
```



#   check the diveinfo ====
```{r dive check}
sites <- c("Palanas", "Wangag", "S. Magbangon", "N. Magbangon", "Cabatoan", "Caridad Cemetery", "Caridad Proper", "Hicgop", "Hicgop South", "Sitio Tugas", "Elementary School", "Sitio Lonas", "San Agustin", "Poroc San Flower", "Poroc Rose", "Visca", "Gabas", "Tamakin Dacot", "Haina", "Sitio Baybayon", "Pangasugan")

good <- filter(dive, site %in% sites)
bad <- anti_join(dive, good)
if (nrow(bad) > 0){
  bad$typeo <- "fix misspelled site"
  (problem <- rbind(problem, bad))
}
rm(good, bad)


```
#   check the clownfish
```{r clown check}
# check fish species
fish <- c("APCL", "APOC", "APPE", "APSE", "APFR", "APPO", "APTH", "PRBI", "NA")
good <- filter(clown, fish_spp %in% fish)
bad <- anti_join(clown, good)
bad <- filter(bad, !is.na(fish_spp), fish_spp != "")
if (nrow(bad) > 0){
  bad$typeo <- "fix fish spp on fish table"
  (problem <- rbind(problem, bad))
}
rm(good, bad)

# check tail colors
colors <- c("YE", "O", "YR", "YP", "Y", "W", "WR", "WP", "BW", "B")
good <- filter(clown, color %in% colors)
bad <- anti_join(clown, good)
bad <- filter(bad, !is.na(color), color != "")
if (nrow(bad) > 0){
  bad$typeo <- "fix tail color on fish table"
(problem <- rbind(problem, bad))
  }
rm(good, bad)

# does the anem_id in fish table match the anem_id in anem table?
# clowndive <- dive$dive_num
# clowndive <- unique(clowndive)
# bad <- compare_dives(clowndive)
# 
# if (nrow(bad) > 0){
#   bad$typeo <- "anemid in fish table doesn't match anem data table"
# }
# problem <- rbind(problem, bad)
# rm(bad, good)

# Are there repeat fin_ID numbers on the clownfish sheet? ####
bad <- clown %>% 
  filter(!is.na(sample_id)) %>% 
  group_by(sample_id) %>% 
  summarise(count = n()) %>% 
  filter(count > 1)
if (nrow(bad) > 0){
  bad$typeo <- "fin_id is repeated"
  (problem <- rbind(problem, bad))
}



# find samples that are lacking an anemone #### this needs to be added to problem - haven't tested -MRS
lack <- clown %>%
    filter(is.na(anem_table_id), !is.na(fish_spp))
# %>% 
  #   select(dive_num, obs_time, tag_id, fin_id, notes) %>% 
  #   filter(!is.na(fin_id) | !is.na(tag_id)))

# if this is zero,
rm(lack) # if it is not zero, look into what is going on on the data sheet

```


# check anem 
```{r anem check}
anems <- c("ENQD", "STME", "HECR", "HEMG", "STHD", "HEAR", "MADO", "HEMA", "STGI", "????", "EMPT")
good <- filter(anem, anem_spp %in% anems)
bad <- anti_join(anem, good)
bad <- bad %>% 
  filter(!is.na(anem_spp), anem_spp != "")
if (nrow(bad) > 0){
  bad$typeo <- "fix anem spp on anem table"
  (problem <- rbind(problem, bad))
}

rm(good, bad)


# are there anemones listed at a different site than they were in other years? 
# all anemones with anem_ids from all years
anem_db <- leyte %>% 
  tbl("anemones") %>% 
  select(anem_table_id, dive_table_id, anem_id) %>%
  filter(!is.na(anem_id), anem_id != "-9999", anem_id != "NULL") %>%
  collect()
# all dives for those anemones
dive_db <- leyte %>% 
  tbl("diveinfo") %>% 
  select(dive_table_id, site) %>% 
  collect() %>% 
  filter(dive_table_id %in% anem_db$dive_table_id)
  
  
anem_db <- left_join(anem_db, dive_db, by = "dive_table_id")
anem_site <- anem_db %>%
  select(anem_id, site) %>%
  distinct() 

# are any anem_ids at more than one site?
dups <- anem_site %>% 
  group_by(anem_id) %>% 
  summarise(num_sites = n()) %>% 
  filter(num_sites > 1)

# got 3 results
dup_site <- anem_db %>% 
  filter(anem_id %in% dups$anem_id)
# these are from the recent dive split that I did at Magbangon.
# Which is the correct site?
dup_dive <- leyte %>% 
  tbl("diveinfo") %>% 
  filter(dive_table_id %in% dup_site$dive_table_id) %>% 
  collect()

# is the same old_anem_id used for multiple anems?
  
double <- anem %>% 
  select(anem_id, anem_obs, old_anem_id) %>% 
  filter(!is.na(anem_id)) %>% 
  distinct() %>% 
  group_by(old_anem_id) %>% 
  summarise(count = n()) %>% 
  filter(count > 1)

dups <- anem %>% 
  select(anem_id, anem_obs, old_anem_id, anem_table_id, dive_table_id) %>% 
  filter(!is.na(anem_id), !is.na(old_anem_id)) %>% 
  filter(old_anem_id %in% double$old_anem_id) %>% 
  arrange(old_anem_id)

# pull in sites for dups
dups <- left_join(dups, select(dive, dive_table_id, site, date), by = "dive_table_id") %>% 
  arrange(old_anem_id)

```

Fix anemones that were observed during a dive that I just split
```{r fix split anem}
# dat <- leyte %>% 
#   tbl("anemones") %>% 
#   collect()
# 
# change <- dat %>% 
#   filter(anem_table_id >= 7661, anem_table_id <= 7675) %>% 
#   mutate(dive_table_id = 588, 
#     corr_message = ifelse(!is.na(corr_message), paste(corr_date, corr_editor, corr_message, sep = ", "), corr_message))
# 
# change <- change %>% 
#   mutate(correction = "Y", 
#     corr_date = "2018-10-09", 
#     corr_editor = "MRS", 
#     corr_message = ifelse(
#       !is.na(corr_message), 
#       "Changed dive_table_id from 324 to 588 because dive was split between N. and S. Magbangon.", 
#       paste("Changed dive_table_id from 324 to 588 because dive was split between N. and S. Magbangon.", corr_message, sep = ", ")))
# 
# # remove rows
# dat <- anti_join(dat, change, by = "anem_table_id")
# dat <- rbind(dat, change)
# 
# # check for duplicated rows
# dup <- dat %>%
#   group_by(anem_table_id) %>% 
#   summarise(n = n()) %>% 
#   filter(n > 1)
#
# dbWriteTable(leyte, "anemones", dat, overwrite = T, row.names = F)
```


# are there missing anemone tag numbers on the clownfish sheet?  #### - begin with the starting anem number for this field season

  # gather the used ids
anem_ids <- clown %>% 
  select(anem_id) %>% 
  filter(!is.na(anem_id), anem_id != "") %>%
  distinct()

x <- c(2938:max(anem_ids$anem_id)) #2938 is the first anem_id for 2018
y <- data.frame(x) %>% 
  rename(anem_id = x) %>% 
  filter(anem_id != 3101, anem_id != 3015, anem_id != 2947, anem_id !=3168, anem_id != 3223, anem_id != 3239) # these tags were probably dropped

bad <- anti_join(y, anem_ids)
if (nrow(bad) > 0){
  bad <- bad %>% 
    mutate(typeo = "anem_id is missing", 
      fin_id = NA)
 problem <- mutate(problem, anem_id = NA)
}
(problem <- rbind(problem, bad))


# is an anemone observed more than once?

 obs_anem <- anem %>% 
    filter(!is.na(anem_spp)) %>% 
    group_by(anem_id) %>% 
    summarise(count = n()) %>% 
    filter(count > 1)


 

# is data in a weird place?
  misplaced <- clown %>% 
    filter(is.na(anem_spp), 
      !is.na(depth) | !is.na(gps) |
        !is.na(anem_dia) | !is.na(egg_height)) %>% 
    filter(!is.na(anem_id) & anem_spp != "EMPT")
  
  
  
    
  # someday when we want to separate multiple fish on one untagged anem to make it not look like multiple anems, can check if the time is the same for multiple fish (or is time the same for identical anems) - this won't work well because it will be hard to tell if it is more than one anem or one anem recorded several times.
  
  

#   format pit scanner data ====
```{r}
# get rid of test tags
pit <- pit %>% 
  filter(city != "989" & city != "999", 
    date >= "2015-01-01") %>%  
  mutate(scan = paste0(city, tag))%>% 
  arrange(date, time)
```
#   examine tag ids on clownfish data sheet
```{r}
tagged <- clown %>% 
  filter(!is.na(tag_id)) %>% 
  select(fish_table_id, tag_id, recap)
```
# compare scans to datasheets ====
```{r}
# make sure both tables are speaking the same language.
tagged <- mutate(tagged, tag_id = as.character(tag_id))
pit <- mutate(pit, scan = as.character(scan))
```


# are there any scans in the clownfish table that are not in the pitscan table?
```{r}
fish_scans <- anti_join(tagged, pit, by = c("tag_id" = "scan"))

# on first run, there are 9 tags in the fish table that must be type-os because they are not in the scan table.  It looks like there is a leading whitespace that is causing this.
# test <- clown %>% 
#   filter(grepl(" ", tag_id))
# # this is the case for 3 of them.
# clown <- clown %>% 
#   mutate(tag_id = str_replace_all(tag_id, " ", ""))

# what is the date, time, of erroneous rows?
test <- left_join(fish_scans, select(clown, fish_table_id, anem_table_id, fish_obs_time), by = "fish_table_id")

# bring in the obs time if needed and the dive table id
test <- left_join(test, select(anem, anem_table_id, dive_table_id, obs_time), by = "anem_table_id")

# bring in the date
test <- left_join(test, select(dive, dive_table_id, date), by = "dive_table_id") %>% select(-anem_table_id, -dive_table_id) %>% 
  arrange(date, obs_time)
```
# are there any scans in the pit table that are not in the fish table
```{r}
pit_scans <- anti_join(pit, tagged, by  = c("scan" = "tag_id"))

# on first run, there are 78 scans in the pit table that might be type-os in the fish table or they might be tags scanned in 2015 that were never installed in a fish.

# of the pit scans that are missing, are any on the dates of the type-o fish?
test4 <- pit_scans %>% 
  filter(date %in% test$date) %>% 
  arrange(date, time)

# fish from test
# "" "" "986112100166389" "986112100172585"

# scanned  from test4
 # "" "" "986112100166309"

# make sure clown is fresh from db
clown <- leyte %>% 
  tbl("clownfish") %>% 
  collect()

change <- clown %>% 
  filter(tag_id == "986112100164019") %>% 
  mutate(tag_id = "986112100164819", 
    corr_message = ifelse(is.na(corr_message), "Changed tag_id because it was a type-o based on the pit scanner at the same time", paste("Changed tag_id because it was a type-o based on the pit scanner at the same time", corr_date, corr_editor, corr_message, sep = ", ")), 
    correction = "Y", 
    corr_date = "2018-10-16", 
    corr_editor = "MRS")

clown <- change_rows(clown, change, "fish_table_id")

# make a backup
backup <- leyte %>% 
  tbl("clownfish") %>% 
  collect()
write_rds(backup, path = "~/Documents/db_backups/clownfish.Rdata")

# dbWriteTable(leyte, "clownfish", clown, row.names = F, overwrite = T)
```



# What tags are in the spreadsheet that were not scanned by the scanner (type-os) - should return 0 rows
spreadsheet <- anti_join(tag_ids, pit, by = c("tag_id" = "scan"))
clown %>% 
  filter(tag_id %in% spreadsheet$tag_id) %>% 
  select(dive_num, obs_time, tag_id)

# if there are rows in spreadsheet, view pit and compare


# What tags are in the scanner that are not in spreadsheet (type-os) - should return 0 rows
anti_join(pit, tag_ids, by = c("scan" = "tag_id"))  
# 818456 was scanned but the fish escaped before they could be tagged so as of 2018-03-14  it has not been used yet.

# make sure that pit tags with N only occur once on the data sheet
multi <- tag_ids %>% 
  filter(recap == "N") %>% 
  group_by(tag_id) %>% 
  summarise(tag_count = n()) %>% 
  filter(tag_count > 1)

# if multi is not zero rows, there is a type-o in one of the rows for each tag listed, double check these. (the recent anti_join(pit, tag_ids) should have also flagged this)

# view any problems that need to be taken care of
problem




# testing ####
# # an anemone came back as being listed in both Caridad and Hicgop South. This anemone is definitely in Hicgop, looking into database to see when it was ever recorded in Caridad.
# load("data/db_backups/anemones_db.Rdata")
# weird <- anem %>% 
#   filter(anem_id == 305)
# weird$corr_message
# 
# # the correction message says changed anem_id from 15 to NULL but the anem_id is not NULL, it is 305.  Very weird.  Let's get the info to go back to the data sheet - ok, changed anem_obs, not anem_id.  Fixed in db
# 
# load("data/db_backups/diveinfo_db.Rdata")
# dive <- dive %>% 
#   filter(dive_table_id %in% weird$dive_table_id)


# # do we have any tags that are scanned as Y and only appear once - compare to db? - # Doesn't seem to be working as of 3/15/18; pulls out 986112100172598 and 986112100172301, both of which were scanned in 2017 when connect directly to database and check...
# load("data/fish_db.Rdata")
# 
# # what are past tags?
# db_tags <- fish_db %>% 
#   select(tag_id) 
# 
# # which tags were marked as recaptures this field season
# current_tags <- clown %>% 
#   filter(recap == "Y") %>% 
#   select(tag_id)
# 
# # are any of these tags not in the db already?
# missing <- anti_join(current_tags, db_tags)
# 

# should be 0 obs ####

# fish anems - vs anem obs

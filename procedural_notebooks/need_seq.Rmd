---
title: "Samples that need sequencing as of `r Sys.Date()`"
output:
  pdf_document: default
  html_notebook: default
---
```{r workspace, echo=FALSE, message=FALSE}
library(knitr)
library(kableExtra)
source("../genomics/scripts/gen_helpers.R")
source("../genomics/scripts/lab_helpers.R")
leyte <- read_db("Leyte")
lab <- read_db("Laboratory")
```

**Samples that have successfully completed sequencing**
These samples have passed Michelle's dDocent filters
```{r success, echo=FALSE, message=FALSE}
# locate the genepop file and read as data frame
genfile <- "../genomics/data/seq17_03g95maf2q30dp15.gen"
genedf <- read_genepop(genfile)

# format the file-----------------------------

# remove columns of loci
genedf <- genedf %>% 
  select(names) %>% 
  rename(ligation_id=names)


# Just in case some of the samples are named with APCL before the ligation_id, create a search term to search for ligation ids within a name
ligid <- "(.+)(L\\d\\d\\d\\d)" 
# change all of the names to ligation id only
genedf$ligation_id <- genedf$ligation_id %>% str_replace(ligid,"\\2")

# get sample ids for these ligations ----------------------------
samples <- samp_from_lig(genedf)

if (nrow(samples) != nrow(genedf)){
  # are there duplicate ligation ids in genedf?
  no_dups <- distinct(genedf, ligation_id) 
    # that wasn't the issue, same number of rows in no_dups as in genedf

  # which ligation ids are in genedf that are not in samples?
  no_sample <- genedf %>% filter(!ligation_id %in% samples$ligation_id)
    # these 11 samples are problem samples that can't be matched to a sample
}else{
  print("All sequenced samples accounted for")
}

# write.csv(samples, file = paste("data/samples_successfully_seq_as_of_", Sys.Date(), ".csv", sep = "" ))

rm(no_dups, no_sample, genedf)

samples <- samples %>% 
  arrange(sample_id)

saveRDS(samples, file = "success_seq_samples.Rdata")
```
`r nrow(samples)` samples have been successfully sequenced.
A list of these samples has been saved as an Rdata file.

The following invisible code is identifying samples by extraction_id that have been digested multiple times and never had enough DNA to be sequenced:
```{r echo=FALSE, message=FALSE}
rem_e <- c("E0266", "E1699", "E0501", "E0525", "E0526", "E0536", "E0540", "E0569", "E0683", "E0686", "E0687", "E0703", "E0713", "E2292", "E0554", "E0741", "E0745", "E0763", "E0795", "E0797", "E0851", "E0885", "E0888", "E0891", "E0964", "E0965", "E0979", "E0980", "E0981", "E1011", "E1036", "E1338", "E1339", "E1347", "E1370", "E2759", "E2775", "E2799", "E2773", "E2763", "E2569", "E2642", "E2738", "E2707", "E2736", "E2753", "E2734", "E2735", "E2737", "E0404", "E0533", "E0555", "E0572", "E0677", "E0725", "E0793", "E1304", "E1306", "E1309", "E1311", "E1313", "E1315", "E1316", "E1319", "E1320", "E1321", "E1322", "E1323", "E1326", "E1327", "E1328", "E1329", "E1332", "E1333", "E1336", "E2690", "E2737", "E0248", "E0267", "E0301", "E0310", "E0314", "E0315", "E0321", "E0322", "E0324", "E0336", "E0340", "E0358", "E0424", "E0462", "E0463", "E0470", "E0476", "E0480", "E0487", "E0490", "E0506", "E0508", "E0512", "E0516", "E0521", "E0532", "E0565", "E2602", "E2607", "E2808")
# sort(rem_e)
```


Out of all of the samples ever collected, which have not been set up for ligation or sequenced?
```{r echo=FALSE, message=FALSE}
full_samp <- leyte %>% 
  tbl("clownfish") %>% 
  select(sample_id) %>% 
  collect()

# which haven't been successfully sequenced?
unseq <- full_samp %>% 
  filter(!sample_id %in% samples$sample_id)


# what is the work history
unseq <- work_history(unseq, "sample_id")

# which of these samples are not currently set up for ligation/sequencing
need <- unseq %>% 
  filter(pool < "P073" | is.na(pool))

unseq <- anti_join(unseq, need)

# are any of these digested since 2017?
dig <- lab %>% 
  tbl("digest") %>% 
  filter(digest_id %in% need$digest_id) %>% 
  select(digest_id, date, notes) %>% 
  collect()
need <- left_join(need, dig, by = "digest_id") %>% 
  rename(dig_notes = notes, dig_date = date)

# make sure none of these sample ids are already set up 
need <- need %>% 
  filter(!sample_id %in% unseq$sample_id)
  
# have these samples ever been digested since 2017?
need <- work_history(need, "sample_id")

# are any of the extracts empty?
extr <- lab %>% 
  tbl("extraction") %>% 
  filter(extraction_id %in% need$extraction_id) %>% 
  select(extraction_id, notes) %>% 
  collect()
need <- left_join(need, extr, by = "extraction_id") %>% 
  filter(!grepl("empty", notes))

# do any of them lack DNA?
need <- need %>% 
  filter(!grepl("no band", notes)) %>% 
  filter(!grepl("No band", notes))

# remove the extraction_ids above that were digested multiple times but always failed
need <- need %>% 
  filter(!extraction_id %in% rem_e)
```
Save the samples that need to be set up for sequencing/ligation/robot as digs_need_seq.Rdata
```{r echo=FALSE, message=FALSE}
save(need, file = "digs_need_seq.Rdata")

```


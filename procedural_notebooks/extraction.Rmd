---
title: '`r paste("Extraction plan for ", params$first, "-", params$last, sep =
  "")`'
output:
  pdf_document: default
  html_document: default
date: '`r Sys.Date()`'
params:
  first: APCL18_095
  last: APCL18_188
  num_samples: 96
---

This is a script for adding samples that are not in the laboratory database and have not been extracted. This is set up to handle one plate at a time.
```{r echo=FALSE, message=FALSE}
source("../genomics/scripts/lab_helpers.R")
library(kableExtra)
```
####Obtain a list of all clownfish sample ids from the Leyte database ####
```{r}
# connect to leyte fieldwork db
leyte <- read_db("Leyte")
# import fish table
# select down to only sample_id numbers and remove any rows without a sample
fish <- leyte %>% tbl("clownfish") %>% 
  # select only the column sample_id
  select(sample_id) %>%             
  # remove any non-sample observations
  filter(!is.na(sample_id)) %>%     
  distinct(sample_id) %>%                         
  # remove any repeat sample_ids (this should not be needed)
  collect()

# make sure each sample_id is only represented once
fish <- distinct(fish)
```
####Select the range of samples in the plate
```{r}
work <- fish %>% 
  filter(sample_id >= params$first, sample_id <= params$last)

# define wells
plate <- data.frame(row = rep(LETTERS[1:8], 12), col = unlist(lapply(1:12, rep, 8))) %>% 
  mutate(sample_id = ifelse(row == "D" & col == 2, "XXXX", NA), 
    sample_id = ifelse(row == "E" & col == 8, "XXXX", sample_id))

samples <- plate %>% 
  filter(is.na(sample_id)) %>% 
  select(-sample_id)

plate <- anti_join(plate, samples, by = c("row", "col"))

samples <- cbind(samples, work)

plate <- rbind(plate, samples) %>% 
  arrange(col, row)
```

####Make a plate map of sample IDs (for knowing where to place fin clips) ####
```{r message=FALSE}
platemap <- as.matrix(reshape2::acast(plate, plate[,1] ~ plate[,2]), value.var = plate[,3])
knitr::kable(platemap, booktabs = T) %>% 
  # use scale_down to get map to fit within the bounds of the pdf
  kable_styling(latex_options = "scale_down")
```
###ONLY DO THIS ONCE 
####Generate extract numbers for database
```{r}
lab <- read_db("Laboratory")
extracted <- lab %>% tbl("extraction") %>% 
  summarise(last = max(extraction_id, na.rm = T)) %>% 
  collect() %>% 
  mutate(last = substr(last, 2,5))

plate <- plate %>% 
  mutate(well = 1:nrow(plate)) %>% 
  mutate(extraction_id = paste("E", well + as.numeric(extracted$last), sep = "")) %>% 
  mutate(well = paste(row, col, sep = "")) %>% 
  mutate(method = "DNeasy96", 
    final_vol = "200")

plate_name <- plate %>% 
  summarise(first = min(extraction_id), 
    last = max(extraction_id, na.rm = T))
```
####Make a platemap with extraction ids
```{r}
map <- plate %>% 
  select(row, col, extraction_id)
  platemap <- as.matrix(reshape2::acast(map, map[,1] ~ map[,2]), value.var = map[,3])
knitr::kable(platemap, booktabs = T) %>% 
  kable_styling()

plate <- plate %>% 
  mutate(plate = paste(plate_name$first, plate_name$last, sep = "-")) %>% 
  select(-row, -col)
```
####Import the extract list into the database
#####Make sure you have created your output PDF for this labwork before sending to the database
```{r}
rm(lab)
lab <- write_db("Laboratory")
# dbWriteTable(lab, "extraction", plate, row.names = F, overwrite = F, append = T)

dbDisconnect(lab)
rm(lab)
```
## Load fin clips

**Calculate the amount of lysis buffer to make**
```{r}
num_samples <- params$num_samples

w_error <- num_samples *1.1

mix <- readr::read_csv("num_samples_w_error, ul_prot_k, ml_ATL_buff
0,0,0") %>% 
mutate(num_samples_w_error = w_error, 
ul_prot_k = w_error * 20 * 0.001, 
ml_ATL_buff = w_error * 180 * 0.001)

kable(mix)
```

1. Set up tubes of fin clips into the plate formation on tube holder block according to plate map.

2. Create the lysis mix in a 50mL falcon tube, **do not vortex (foamy)**, and pour into 50mL reservoir.

3. Place an 8 well strip of collection tubes (H position labeled with the column number) onto the loading plate and fill with 200uL of lysis mix.

4. Double check that the next column of tubes matches the plate map

5. Place the fins in the collection tubes

6. Cap the tubes

7. When the entire plate is done, place in the incubator overnight.

8. Allow the plate to cool and check the caps to make sure they are on securely.

9. Follow the Qiagen protocol for plate extraction.

#### Next follow the protocol for gel and pico_plate to check quality and quantity of extracts


---
title: "Katrina's Trios 2018-07-09"
output: html_notebook
---

Katrina found some clownfish that are descendents of parents caught at different sites.

```{r load csv, message=FALSE}
library(dplyr)
info <- readr::read_csv(file = "~/Downloads/20180709colony_dist_allyears_allmeta.csv")
```

There are 3 cases that set off a flag for Katrina.

```{r enter strange cases}
case <- readr::read_csv("offspring, P1, P2
  L1318, L0605, L2536
  L0847, L0721, L2557
  L0298, L2927, L1055")
```

Are there any notes for any of these ligation ids?
```{r find notes}
source("../genomics/scripts/lab_helpers.R")
lab <- read_db("Laboratory")

notes <- lab %>% 
  tbl("ligation") %>% 
  filter(ligation_id %in% case$offspring |
    ligation_id %in% case$P1 |
    ligation_id %in% case$P2) %>% 
  collect()
```
L2536 and L2557 have notes in the ligation table that they have questionable sample identity.  Michelle has notes in evernote that these samples were part of the mis-labeled plates fiasco of 2015 and their sample identity is questionable.
```{r get sample ids for problem samples}
indv <- info %>% 
  filter(par2_ligation_id == "L2536" | par2_ligation_id == "L2557") %>% 
  select(par2_ligation_id, par2_sample_id) 
```
Were any samples on that extraction plate from Sitio Baybayon?
```{r find extr plate}
extr <- lab %>% 
  tbl("extraction") %>% 
  filter(sample_id %in% indv$par2_sample_id) %>%
  select(sample_id, extraction_id, plate, well, notes) %>%
  collect()

plate <- lab %>% 
  tbl("extraction") %>% 
  filter(plate %in% extr$plate) %>% 
  select(sample_id) %>% 
  collect()

leyte <- read_db("Leyte")
site <- leyte %>% 
  tbl("clownfish") %>% 
  filter(sample_id %in% plate$sample_id) %>% 
  select(sample_id, anem_table_id) %>% 
  collect()
anem <- leyte %>% 
  tbl("anemones") %>% 
  filter(anem_table_id %in% site$anem_table_id) %>% 
  select(anem_table_id, dive_table_id, obs_time) %>% 
  collect()
site <- left_join(site, anem, by = "anem_table_id")
rm(anem)
dive <- leyte %>% 
  tbl("diveinfo") %>% 
  filter(dive_table_id %in% site$dive_table_id) %>% 
  select(dive_table_id, date, site) %>% 
  collect()
site <- left_join(site, dive, by = "dive_table_id") %>% 
  select(-dive_table_id, -anem_table_id)
rm(dive)
```
All samples on the extraction plate were from `r distinct(site, site)`

What about the ligation plate?
```{r find dig plate}
# get the digest ids
dig <- lab %>% 
  tbl("digest") %>% 
  filter(extraction_id %in% extr$extraction_id) %>%
  select(digest_id, extraction_id) %>%
  collect()

# get the ligation ids
lig <- lab %>%
  tbl("ligation") %>% 
  filter(digest_id %in% dig$digest_id) %>% 
  select(ligation_id, digest_id, well, plate, notes) %>% 
  collect()

plate <- lab %>% 
  tbl("ligation") %>% 
  filter(plate %in% lig$plate) %>% 
  select(digest_id, ligation_id) %>% 
  collect()

extr_ids <- lab %>% 
  tbl("digest") %>% 
  filter(digest_id%in% plate$digest_id) %>% 
  select(extraction_id) %>% 
  collect()

sample_ids <- lab %>%
  tbl("extraction") %>% 
  filter(extraction_id %in% extr_ids$extraction_id) %>% 
  select(sample_id) %>% 
  collect()


leyte <- read_db("Leyte")
site <- leyte %>% 
  tbl("clownfish") %>% 
  filter(sample_id %in% sample_ids$sample_id) %>% 
  select(sample_id, anem_table_id) %>% 
  collect()
anem <- leyte %>% 
  tbl("anemones") %>% 
  filter(anem_table_id %in% site$anem_table_id) %>% 
  select(anem_table_id, dive_table_id, obs_time) %>% 
  collect()
site <- left_join(site, anem, by = "anem_table_id")
rm(anem)
dive <- leyte %>% 
  tbl("diveinfo") %>% 
  filter(dive_table_id %in% site$dive_table_id) %>% 
  select(dive_table_id, date, site) %>% 
  collect()
site <- left_join(site, dive, by = "dive_table_id") %>% 
  select(-dive_table_id, -anem_table_id)
rm(dive)
```
There were 12 fish from Sitio Baybayon on the ligation plate.  Our problem samples were in wells A7 and F9.
```{r fish from Sitio Baybayon}
sitio <- site %>% 
  filter(site == "Sitio Baybayon")
```

Get sample ids for all of the ligation ids
```{r sample ids from lig ids}
source("../genomics/scripts/gen_helpers.R")
samp <- samp_from_lig(plate)

map <- lab %>% 
  tbl("ligation") %>% 
  filter(ligation_id %in% samp$ligation_id) %>% 
  select(ligation_id, well) %>%
  collect()

map <- left_join(map, samp, by = "ligation_id")
map <- left_join(map, site, by = "sample_id") 
map <- map %>% 
  select(site, well) %>% 
    mutate(row = substr(well, 1, 1), 
      col = as.numeric(substr(well, 2, 3)))
  map <- map %>% 
    select(row, col, site)
  platemap <- as.matrix(reshape2::acast(map, map$row ~ map$col))

knitr::kable(platemap)
```





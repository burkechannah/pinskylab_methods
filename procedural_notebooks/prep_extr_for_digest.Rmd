---
title: '`r paste("Digest plan for ", params$first, "-", params$last, sep = "")`'
params:
  id: digest_id
  first_sample: E4551
  last_sample: E5126
  type: digest
output:
  pdf_document: default
---
This document is able to take a set of extracts and prepare them for digest by assigning digest_ids to them, mapping where they will go in the digest plate, and mapping where to find them in extraction plates. Currently this only fills one plate and puts the excess in tubes.  Adjust as needed.

```{r workspace, echo = FALSE, message=FALSE}
source("../../laboratory/scripts/lab_helpers.R")
library(knitr)
library(kableExtra)
library(ggplot2)
lab <- read_db("Laboratory")
```

**Get a list of extracts to be digested, **
It is important to have extraction_id, sample_id, well, plate, and quant.  
```{r extracts, echo = FALSE}
extr <- lab %>%
  tbl("extraction") %>% 
  filter(extraction_id >= params$first_sample, 
         extraction_id <= params$last_sample) %>% 
  select(sample_id, extraction_id, well, plate, quant) %>% 
  collect()
```

**How many plates will this fill?**

```{r num_plates, echo = FALSE}
nrow(extr)/96
```

The extractions are going to go into the same wells they were in on the extraction plate, except for the blanks.  Find the blanks on the extraction plates and replace those extraction ids.
```{r}
extr <- extr %>% 
  mutate(extraction_id = ifelse(sample_id == "XXXX", "XXXX", extraction_id))
```
**Generate a digest_id place holder**
```{r digest_id, echo = FALSE}
dig_max <- lab %>% 
  tbl("digest") %>% 
  select(digest_id) %>% 
  summarise(max = max(digest_id)) %>% 
  collect() %>% 
  mutate(max = as.numeric(substr(max, 2, 5)))

extr <- extr %>% 
  # split out the row and column in order to put the wells in order
  mutate(col = as.numeric(substr(well, 2, 3)), 
    row = substr(well, 1,1)) %>% 
  arrange(plate, col, row) %>% 
  # create digest ids
  mutate(digest_id = 1:nrow(extr)) %>% 
  mutate(digest_id = digest_id + dig_max$max) %>% 
  mutate(digest_id = paste("D", digest_id, sep = "")) %>% 
  # calcuate the ng of DNA added to the digest
  mutate(ng_in = 30 * quant)
```

Name digest plates
```{r name_dig_plates, echo=FALSE}
for_plates <- extr %>% 
  select(contains("id"), well, plate, -sample_id, ng_in) %>% 
  mutate(num = 1:nrow(extr))

plates <- for_plates %>% 
  select(plate) %>% 
  distinct() %>% 
  arrange(plate)

for_plates$dig_plate <- NA
for (i in 1:nrow(plates)){
  for_plates <- for_plates %>% 
    mutate(dig_plate = ifelse(plate == plates$plate[i], paste("plate", i, sep = ""), dig_plate))
  x <- for_plates %>% 
    filter(plate == plates$plate[i])
  first <- x %>% 
    summarise(min(digest_id))
  last <- x %>% 
    summarise(max(digest_id))
  for_plates <- for_plates %>% 
    mutate(dig_plate = ifelse(plate == plates$plate[i], paste(first, "-", last, sep = ""), dig_plate))
}
```
**Make plate maps of destinations**

```{r dig_dest, echo = FALSE, message=FALSE}

plates <- for_plates %>% 
  select(dig_plate) %>% 
  distinct() %>% 
  arrange(dig_plate)
plate1 <- for_plates %>% 
  filter(dig_plate == plates$dig_plate[1]) %>% 
  mutate(ng_in = ng_in/10) %>% 
  mutate(filter = 30) %>% 
  mutate(filter = ifelse(ng_in >= 5000 & ng_in <= 10000, 15, filter), 
         filter = ifelse(ng_in > 10000, 7, filter))

# want to make a heatmap here based on quant so I know which to put 15uL in

x <- heatmap(plate1)
ggsave(paste("../procedural_notebooks/plots/", plate1$dig_plate, ".pdf", sep = ), device = "pdf")




dig_dest <- plate_from_db(for_plates, "digest_id")
kable(platemap)
```
```{r echo = F, message=F}
extr_dest <- plate_from_db(extr, "extraction_id")
kable(platemap)
```

### Make plate maps of source plates
```{r echo = F, fig.width=10, message=F}
# define the source plates
sources <- extr %>% 
  select(plate) %>% 
  filter(plate != "XXXX") %>% 
  distinct() %>% 
  arrange(plate)

# create heat maps of the plates
for (i in 1:nrow(sources)){
  library(ggplot2)
  source <- lab %>% 
    tbl("extraction") %>% 
    filter(plate == sources$plate[i]) %>% 
    collect() %>% 
    mutate(filter = ifelse(extraction_id %in% extr$extraction_id, "yes", "no"))
  x <- heatmap(source, extraction_id)
  print(x)
}
```


```{r echo=F, message=F}
# write the data to the database
w_lab <- write_db("Laboratory")
dig <- extr %>% 
  select(digest_id, extraction_id, ng_in, well)
# dbWriteTable(w_lab, "digest", dig, append = T, row.names = F)

```



### Prepare digest plate by adding 30ÂµL of sample to each well according to the digest map prepared above.  If you are not continuing on to the digest step now, seal the plate with film, label it, and put it in the fridge.






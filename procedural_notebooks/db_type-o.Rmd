---
title: "Fix APCL type-o"
output:
  pdf_document: default
  html_notebook: default
date: '`r Sys.Date()`'
---

Allison found some weird fish:
Fish with species APPE that has a tag_id (that is also associated with three sightings of an APCL): tag_id: 982000411818554, anem_table_id: 11196, fish_table_id: 11183, dive_table_id: 563
Fish tagged at 2.6cm: tag_id: 982000411818698, fish_table_id: 11777, anem_table_id: 11023, dive_table_id: 494

Allison also found 4 tag_ids that show up at two sites, listed below (though I suppose it's possible these are unusual fish that swam far as adults...). Just sending now so I don't forget to do it later, no rush at all (and I know you don't have access to the 2018 sheets in FL anyway).

tag_id 982000411818588, shows up at Wangag in 2017 (dive_num 50, dive_table_id 416, anem_table_id 9427) and at Hicgop South in 2018 (dive_num 39, dive_table_id 543, anem_table_id 10623)
tag_id 982000411818610, at Poroc San Flower twice in 2017 (dive_num 38, dive_table_id 392, anem_table_id 9277 and dive_num 74, dive_table_id 458, anem_table_id 9815) and at San Agustin in 2018 (dive_num 61, dive_table_id 581, anem_table_id 10475)
tag_id 985153000401241, at Wangag in 2015 (dive_num 12, dive_table_id 259, anem_table_id 6468) and 2017 (dive_num 50, dive_table_id 416, anem_table_id 9445) and at Palanas in 2018 (dive_num 6, dive_table_id 483, anem_table_id 11432)
tag_id 986112100172501, shows up twice at Wangag in 2018 (dive_num 9, dive_table_id 486, anem_table_id 11315 and dive_num 50, dive_table_id 569, anem_table_id 11409) and in Haina in 2017 (dive_num 78, dive_table_id 462, anem_table_id 11409). Both the Haina capture and the Wangag capture w/anem_table_id 11315 say N for recap and have (different) fin_ids and sample_ids 


Information provided:
```{r}
info <- readr::read_csv(
  "tag_id, anem_table_id, fish_table_id, dive_table_id
  982000411818554, 11196, 11183, 563
  982000411818698, 11023, 11777, 494
  982000411818588, NA, NA, NA
  982000411818610, NA, NA, NA
  985153000401241, NA, NA, NA
  986112100172501, NA, NA, NA"
  )
```

```{r echo=FALSE, message=FALSE}
source("../genomics/scripts/lab_helpers.R")
source("../genomics/scripts/field_helpers.R")
library(knitr)
```

```{r}
leyte <- read_db("Leyte")

day <- leyte %>%
    tbl("diveinfo") %>%
    select(date, dive_table_id, site, dive_num) %>%
    collect() %>% 
    filter(dive_table_id %in% info$dive_table_id)

info <- left_join(info, day, by = "dive_table_id")
rm(day)

fish <- leyte %>% 
  tbl("clownfish") %>% 
  select(fish_table_id, fish_obs_time, size, color) %>% 
  filter(fish_table_id %in% info$fish_table_id) %>% 
  collect()

info <- left_join(info, fish, by = "fish_table_id")
rm(fish)
```
For the fish with the tag ending in 818698, the pencil says 7.6 but is entered as 2.6.  

For the fish with the tag ending in 818554, no idea how that tag_id got on that data row.  It is also on the row where it belongs.  Weird.

For the fish with tags at multiple locations:
```{r}
fish <- leyte %>% 
  tbl("clownfish") %>% 
  filter(tag_id %in% info$tag_id) %>% 
  select(fish_table_id, anem_table_id, tag_id) %>% 
  collect()

# remove the fish you've already solved
fish <- fish %>% 
  filter(tag_id != 982000411818554, tag_id != 982000411818698)
rm(info)

# get the anemone info
anem <- leyte %>% 
  tbl("anemones") %>% 
  filter(anem_table_id %in% fish$anem_table_id) %>% 
  select(anem_table_id, dive_table_id, obs_time, anem_id) %>% 
  collect()
fish <- left_join(fish, anem, by = "anem_table_id")

# get dive info
dive <- leyte %>% 
  tbl("diveinfo") %>% 
  filter(dive_table_id %in% fish$dive_table_id) %>% 
  select(dive_table_id, site, date, dive_num) %>% 
  collect()
fish <- left_join(fish, dive, by = "dive_table_id")
rm(anem, dive)

tag_list <- substr(fish$tag_id, 4, 15)

# double check tag scan info
tags <- leyte %>% 
  tbl("pitscan") %>% 
  filter(tag %in% tag_list) %>% 
  collect()

tags <- tags %>% 
  mutate(tag_id = paste(city, tag, sep = ""))
```
All of the tags were actually for fish that moved sites (or at least the pit scanner scanned those tags at different sites) except for the last one : 986112100172501 involved a type-o where in 2017 the tag scanned was 986112100172301 but was typed in incorrectly.

---
title: "2016 leyte database issues"
output: html_notebook
params:
  year:  2016
---
```{r setup}
source("../genomics/scripts/lab_helpers.R")
library(tidyverse)
leyte <- write_db("Leyte")
```


On 2018-10-16, when I was using the skeleton of our field type-o checking code against data in the database I found that a few tag_ids are repeated on rows they shouldn't be.  When I tried to get to the bottom of it by checking the data sheet, I saw that the fish in the fish table do not match the rows on the data sheet.
For example anem_table_id 7531.

```{r the problem}
prob <- leyte %>% 
  tbl("clownfish") %>% 
  filter(anem_table_id == 7531) %>% 
  collect() %>% 
  arrange(fin_id)
```

Work through the Excel Doc

# 1. Diveinfo
```{r diveinfo from excel}
dive_xl <- read_csv("GPSSurveys2016_dive.csv", col_types = cols(
  DiveNum = col_integer(),
  CollectingAPCL = col_character(),
  Date = col_character(),
  Name = col_character(),
  Municipality = col_character(),
  GPS = col_integer(),
  Divers = col_character(),
  StartTime = col_character(),
  EndTime = col_character(),
  Duration = col_character(),
  Discontinuous = col_integer(),
  PauseStart = col_character(),
  PauseEnd = col_character(),
  Weather = col_character(),
  Current_knots = col_character(),
  WaveHeight_cm = col_character(),
  Visibility_m = col_character(),
  Wind_mph = col_character(),
  Tide = col_character(),
  Topo_m = col_character(),
  DepthTop_m = col_double(),
  DepthBottom_m = col_double(),
  Cover = col_character(),
  Notes = col_character()
))

# convert names to all lower case
names(dive_xl) <- str_to_lower(names(dive_xl))

dive_xlr <- dive_xl %>% 
  rename(dive_num = divenum, 
    dive_type = collectingapcl, 
    start_time = starttime, 
    end_time = endtime, 
    pause_start = pausestart, 
    pause_end = pauseend, 
    wave_height_cm = waveheight_cm, 
    depth_top_m = depthtop_m, 
    depth_bottom_m = depthbottom_m) 

# compare to db version
test <- left_join(dive_db, dive_xlr, by = "dive_num") 

# everything looks the same.

```
# 2. Anemone info
```{r}
anem_xl <- read_csv("GPSSurveys2016_clownfish.csv", 
  col_types = cols(
  id = col_integer(),
  DiveNum = col_integer(),
  ObsTime = col_character(),
  Collector = col_character(),
  GPS = col_integer(),
  Depth_m = col_double(),
  Depth_ft = col_integer(),
  AnemSpp = col_character(),
  AnemDia = col_integer(),
  oldAnemID = col_integer(),
  AnemID = col_integer(),
  AnemSampleID = col_integer(),
  Spp = col_character(),
  Size1 = col_double(),
  Col1 = col_character(),
  Recap1 = col_character(),
  TagID1 = col_double(),
  ID1 = col_integer(),
  Size2 = col_double(),
  Col2 = col_character(),
  Recap2 = col_character(),
  TagID2 = col_double(),
  ID2 = col_integer(),
  Size3 = col_double(),
  Col3 = col_character(),
  Recap3 = col_character(),
  TagID3 = col_double(),
  ID3 = col_integer(),
  Size4 = col_double(),
  Col4 = col_character(),
  Recap4 = col_character(),
  TagID4 = col_double(),
  ID4 = col_integer(),
  Size5 = col_double(),
  Col5 = col_character(),
  Recap5 = col_character(),
  TagID5 = col_double(),
  ID5 = col_integer(),
  Size6 = col_double(),
  Col6 = col_character(),
  Recap6 = col_character(),
  TagID6 = col_double(),
  ID6 = col_integer(),
  Size7 = col_character(),
  Col7 = col_character(),
  Recap7 = col_character(),
  TagID7 = col_double(),
  ID7 = col_integer(),
  Spp2 = col_character(),
  Spp2Size1 = col_double(),
  Spp2Size2 = col_integer(),
  Spp2Size3 = col_integer(),
  Spp2Size4 = col_integer(),
  Notes = col_character()
))

names(anem_xl) <- str_to_lower(names(anem_xl))

anem_xlr <- anem_xl %>% 
  select(-gps, -spp:-spp2size4) %>% 
  rename(dive_num = divenum, 
    obs_time = obstime, 
   anem_spp = anemspp, 
    anem_dia = anemdia, 
    old_anem_id = oldanemid, 
    anem_id = anemid, 
    anem_sample_id = anemsampleid) 

# import dive_table_id based on dive_num
anem_xld <- left_join(anem_xlr, select(dive_db, dive_table_id, dive_num), by = "dive_num")

# find rows that don't match
row_to_investigate <- tibble()
for (i in seq(anem_xld$id)){
  x <- anem_db %>% 
    filter(dive_table_id == anem_xld$dive_table_id[i] & obs_time == anem_xld$obs_time[i])
  if (nrow(x) > 1){
    row_to_investigate <- rbind(row_to_investigate, x)
  }
}

row_to_investigate <- row_to_investigate %>% 
  distinct()
y <- row_to_investigate
x <- anem_db %>% 
    filter(dive_table_id == y$dive_table_id[i] & obs_time == y$obs_time[i])

```



# A. DB version
```{r db versions}

dive_db <- leyte %>% 
  tbl("diveinfo") %>% 
  collect() %>% 
  filter(grepl(params$year, date))

anem_db <- leyte %>% 
  tbl("anemones") %>% 
  filter(dive_table_id %in% dive_db$dive_table_id) %>% 
  collect()

clown_db <- leyte %>% 
  tbl("clownfish") %>% 
  filter(anem_table_id %in% anem_db$anem_table_id) %>% 
  collect()
```



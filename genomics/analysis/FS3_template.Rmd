---
title: "SNP FILTERING"
output:
  html_document:
    toc: yes
  html_notebook:
    code_folding: hide
    df_print: paged
    highlight: kate
    theme: yeti
    toc: yes
---

To use this script, find and replace 20181125 with the current project date

```{r load libraries}

# knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# source("~/02-apcl-ddocent/APCL_analysis/scr/libraries.R")
# source("~/02-apcl-ddocent/APCL_analysis/scr/ggplot.R")
source("~/02-apcl-ddocent/APCL_analysis/scr/VCFfilterstats.R")
# source("~/02-apcl-ddocent/APCL_analysis/scr/xtrafunctions.R")
```

 
```{bash}
mkdir /local/home/michelles/02-apcl-ddocent/APCL_analysis/20181125/results
```


## Raw data stats

### Query stats

Query raw stats using vcftools.

```{bash query raw stats}
cd /local/home/michelles/02-apcl-ddocent/APCL_analysis/20181125
# depth indv/locus
vcftools --vcf /data/apcl/all_samples/20181125/TotalRawSNPs.vcf --out results/raw --depth
vcftools --vcf /data/apcl/all_samples/20181125/TotalRawSNPs.vcf  --out results/raw --site-mean-depth

# missing data indv/locus
vcftools --vcf /data/apcl/all_samples/20181125/TotalRawSNPs.vcf  --out results/raw --missing-indv
vcftools --vcf /data/apcl/all_samples/20181125/TotalRawSNPs.vcf  --out results/raw --missing-site

# heterozygosity per individual
vcftools --vcf /data/apcl/all_samples/20181125/TotalRawSNPs.vcf --out results/raw --het

# SNP call quality
vcftools --vcf /data/apcl/all_samples/20181125/TotalRawSNPs.vcf --out results/raw --site-quality
```

### Visualize

```{r stats raw, fig.height=20, fig.width=10, message=FALSE, warning=FALSE}

# load stats files ----
ind_stats_raw <- read.ind.stats(dir = "results", vcf = "BONNET_raw")

loc_stats_raw <- read.loc.stats(dir = "results", vcf = "BONNET_raw")

# plot missing data per indv ----
p1 <- ggplot(ind_stats_raw, aes(x = MISS_BONNET_raw)) +
  geom_histogram(binwidth = .01, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(MISS_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0.5),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "missing data per indv") +
  theme_standard

# plot Fis per indv ----
p2 <- ggplot(ind_stats_raw, aes(x = Fis_BONNET_raw)) +
  geom_histogram(binwidth = .01, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(Fis_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "Fis per indv") +
  theme_standard

# plot read depth per indv ----
p3 <- ggplot(ind_stats_raw, aes(x = MEAN_DEPTH_BONNET_raw)) +
  geom_histogram(binwidth = 10, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(MEAN_DEPTH_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean read depth per indv") +
  theme_standard

# plot depth vs missing ----
p4 <- ggplot(ind_stats_raw, aes(x = MEAN_DEPTH_BONNET_raw, y = MISS_BONNET_raw)) +
  geom_point() +
  geom_vline(aes(xintercept = mean(MEAN_DEPTH_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(MISS_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 0.5),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean depth per indv", y = "% missing data") +
  theme_standard

# plot Fis vs missing data per indv ----
p5 <- ggplot(ind_stats_raw, aes(x = Fis_BONNET_raw, y = MISS_BONNET_raw)) +
  geom_point() +
  geom_vline(aes(xintercept = mean(Fis_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(MISS_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 0.5),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "Fis per indv", y = "% missing data") +
  theme_standard

# plot Fis vs mean depth per indv ----
p6 <- ggplot(ind_stats_raw, aes(x = Fis_BONNET_raw, y = MEAN_DEPTH_BONNET_raw)) +
  geom_point() +
  geom_vline(aes(xintercept = mean(Fis_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(MEAN_DEPTH_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "Fis per indv", y = "mean depth per indv") +
  theme_standard

# plot distribution missing data per locus ----
p7 <- ggplot(loc_stats_raw, aes(x = MISS_BONNET_raw)) +
  geom_histogram(binwidth = 0.01, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(MISS_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0.1),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "% missing data per locus") +
  theme_standard

# plot distribution mean read depth ----
p8 <- ggplot(loc_stats_raw, aes(x = MEAN_DEPTH_BONNET_raw)) +
  geom_histogram(binwidth = 5, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(MEAN_DEPTH_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean read depth per locus") +
  theme_standard

# plot read depth vs missing data ----
p9 <- ggplot(loc_stats_raw, aes(x = MEAN_DEPTH_BONNET_raw, y = MISS_BONNET_raw)) +
  geom_point() +
  geom_vline(aes(xintercept = mean(MEAN_DEPTH_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(MISS_BONNET_raw, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 0.1),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean depth per locus", y = "% missing data") +
  theme_standard

# plot no of SNPs per locus ----
p10 <- loc_stats_raw %>%
  count(CHR) %>%
  ggplot(aes(x = n)) +
  geom_histogram(binwidth = 1, color = "black", fill = "grey95") + 
  labs(x = "number of SNPs per locus") +
  theme_standard

temp <- loc_stats_raw %>%
  count(CHR)

# plot number of SNPs per contig vs. mean depth ----
p11 <- left_join(temp, loc_stats_raw) %>%
  ggplot() +
  geom_point(aes(x = n, y = MEAN_DEPTH_BONNET_raw)) +
  labs(x = "number of SNPs per contig", y = "mean depth") +
  theme_standard

# plot depth vs SNP quality ----
site_qual <- read.table("results/BONNET_raw.lqual", 
                        header = TRUE, stringsAsFactors = FALSE) %>%
  mutate(PROB = 10^(-QUAL/10))

temp <- data.frame(loc_stats_raw$MEAN_DEPTH_BONNET_raw, site_qual$QUAL) %>%
  rename(depth = loc_stats_raw.MEAN_DEPTH_BONNET_raw, qual = site_qual.QUAL)

p12 <- ggplot(temp, aes(x = depth, y = qual)) +
  geom_point(size = 1) +
  geom_vline(aes(xintercept = mean(depth, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(qual, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean depth per locus", y = "SNP quality") +
  theme_standard

m1 <- multiplot(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12, cols=2)

```

Data set contains r nrow(ind_stats_raw)` individuals and r nrow(loc_stats_raw)` loci.


## Filtering scheme 3

### Step 1: Filter loci

Filter loci with minimum SNP call quality per locus < 20, minimum genotype depth < 5, then remove loci with mean minimum depth < 15, filter loci with minor allele count < 3, finally apply genotype call rate > 95%.

```{bash}

##
vcftools --vcf data/BONNET/TotalRawSNPs.vcf --out data/BONNET/BONNET_minQ20minDP5 --minQ 20 --minDP 5 --recode --recode-INFO-all

# depth indv/locus
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --depth
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --site-mean-depth
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --geno-depth

# missing data indv/locus
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --missing-indv
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --missing-site

# allele freq/indv freq buden
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --indv-freq-burden
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --freq2
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --singletons
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --012

# heterozygosity per individual
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out results/BONNET_minQ20minDP5 --het

# SNP call quality
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf--out results/BONNET_minQ20minDP5 --site-quality


##
vcftools --vcf data/BONNET/BONNET_minQ20minDP5.recode.vcf --out data/BONNET//BONNET_minQ20minDP5meanDP10 --min-meanDP 15 --recode --recode-INFO-all

# depth indv/locus
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --depth
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --site-mean-depth
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --geno-depth

# missing data indv/locus
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --missing-indv
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --missing-site

# allele freq/indv freq buden
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --indv-freq-burden
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --freq2
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --singletons
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --012

# heterozygosity per individual
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --het

# SNP call quality
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out results/BONNET_minQ20minDP5meanDP10 --site-quality


##
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10.recode.vcf --out data/BONNET/BONNET_minQ20minDP5meanDP10mac3 --mac 3 --recode --recode-INFO-all

# depth indv/locus
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --depth
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --site-mean-depth
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --geno-depth

# missing data indv/locus
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --missing-indv
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --missing-site

# allele freq/indv freq buden
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --indv-freq-burden
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --freq2
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --singletons
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --012

# heterozygosity per individual
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --het

# SNP call quality
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3 --site-quality


##
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3.recode.vcf --out data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95 --max-missing 0.95 --recode --recode-INFO-all

# depth indv/locus
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --depth
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --site-mean-depth
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --geno-depth

# missing data indv/locus
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --missing-indv
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --missing-site

# allele freq/indv freq buden
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --indv-freq-burden
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --freq2
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --singletons
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --012

# heterozygosity per individual
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --het

# SNP call quality
vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out results/BONNET_minQ20minDP5meanDP10mac3geno95 --site-quality

```

Decompose variants and retain only SNPs.

```{bash}

vcfallelicprimitives data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --keep-info --keep-geno > data/BONNET/SNPs.vcf

vcftools --vcf data/BONNET/SNPs.vcf --out data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.SNPs --remove-indels --recode --recode-INFO-all

vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.SNPs --out results/BONNET_minQ20minDP5meanDP10mac3geno95.SNPs  --missing-indv

```

### Step 2: Identify individuals with > 25% missing data:

```{r}

imissing <- read.table("results/BONNET_minQ20minDP5meanDP10mac3geno95.imiss",
                       header = TRUE, stringsAsFactors = FALSE)

ggplot(imissing, aes(x = F_MISS)) +
  geom_histogram(binwidth = .05, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(F_MISS, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0.25),
                 color = "darkblue", linetype = "dashed", size = 1) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(x = "missing data per indv") +
  theme_standard

LQ_indv <- imissing %>%
  filter(F_MISS > 0.25) %>%
  select(INDV)

write.table(LQ_indv, "data/BONNET//LQ_Ind_FIL-3", 
            col.names = FALSE, row.names = FALSE, quote = FALSE)

```

Remove flagged individuals:

```{bash}

vcftools --vcf data/BONNET/BONNET_minQ20minDP5meanDP10mac3geno95.recode.vcf --out data/BONNET/BONNET_FIL-3 --remove data/BONNET/LQ_Ind_FIL-3 --recode --recode-INFO-all

# depth indv/locus
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --depth
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --site-mean-depth
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --geno-depth

# missing data indv/locus
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --missing-indv
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --missing-site

# allele freq/indv freq buden
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --indv-freq-burden
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --freq2
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --singletons
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --012

# heterozygosity per individual
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --het

# SNP call quality
vcftools --vcf data/BONNET/BONNET_FIL-3.recode.vcf --out results/BONNET_FIL-3 --site-quality

```

### Plot stats for filtered data set

```{r stats FIL 3, fig.height=20, fig.width=10, message=FALSE, warning=FALSE}

# load stats files ----
ind_stats_FIL_3 <- read.ind.stats(dir = "results", vcf = "BONNET_FIL-3")

loc_stats_FIL_3 <- read.loc.stats(dir = "results", vcf = "BONNET_FIL-3")

# plot missing data per indv ----
p1 <- ggplot(ind_stats_FIL_3, aes(x = `MISS_BONNET_FIL-3`)) +
  geom_histogram(binwidth = .01, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(`MISS_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0.5),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "missing data per indv") +
  theme_standard

# plot Fis per indv ----
p2 <- ggplot(ind_stats_FIL_3, aes(x = `Fis_BONNET_FIL-3`)) +
  geom_histogram(binwidth = .01, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(`Fis_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "Fis per indv") +
  theme_standard

# plot read depth per indv ----
p3 <- ggplot(ind_stats_FIL_3, aes(x = `MEAN_DEPTH_BONNET_FIL-3`)) +
  geom_histogram(binwidth = 10, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(`MEAN_DEPTH_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean read depth per indv") +
  theme_standard

# plot depth vs missing ----
p4 <- ggplot(ind_stats_FIL_3, aes(x = `MEAN_DEPTH_BONNET_FIL-3`, y = `MISS_BONNET_FIL-3`)) +
  geom_point() +
  geom_vline(aes(xintercept = mean(`MEAN_DEPTH_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(`MISS_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 0.5),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean depth per indv", y = "% missing data") +
  theme_standard

# plot Fis vs missing data per indv ----
p5 <- ggplot(ind_stats_FIL_3, aes(x = `Fis_BONNET_FIL-3`, y = `MISS_BONNET_FIL-3`)) +
  geom_point() +
  geom_vline(aes(xintercept = mean(`Fis_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(`MISS_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 0.5),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "Fis per indv", y = "% missing data") +
  theme_standard

# plot Fis vs mean depth per indv ----
p6 <- ggplot(ind_stats_FIL_3, aes(x = `Fis_BONNET_FIL-3`, y = `MEAN_DEPTH_BONNET_FIL-3`)) +
  geom_point() +
  geom_vline(aes(xintercept = mean(`Fis_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(`MEAN_DEPTH_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "Fis per indv", y = "mean depth per indv") +
  theme_standard

# plot distribution missing data per locus ----
p7 <- ggplot(loc_stats_FIL_3, aes(x = `MISS_BONNET_FIL-3`)) +
  geom_histogram(binwidth = 0.01, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(`MISS_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 0.1),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "% missing data per locus") +
  theme_standard

# plot distribution mean read depth ----
p8 <- ggplot(loc_stats_FIL_3, aes(x = `MEAN_DEPTH_BONNET_FIL-3`)) +
  geom_histogram(binwidth = 5, color = "black", fill = "grey95") +
  geom_vline(aes(xintercept = mean(`MEAN_DEPTH_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean read depth per locus") +
  theme_standard

# plot read depth vs missing data ----
p9 <- ggplot(loc_stats_FIL_3, aes(x = `MEAN_DEPTH_BONNET_FIL-3`, y = `MISS_BONNET_FIL-3`)) +
  geom_point() +
  geom_vline(aes(xintercept = mean(`MEAN_DEPTH_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(`MISS_BONNET_FIL-3`, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 0.1),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean depth per locus", y = "% missing data") +
  theme_standard

# plot no of SNPs per locus ----
p10 <- loc_stats_FIL_3 %>%
  count(CHR) %>%
  ggplot(aes(x = n)) +
  geom_histogram(binwidth = 1, color = "black", fill = "grey95") + 
  labs(x = "number of SNPs per locus") +
  theme_standard

temp <- loc_stats_FIL_3 %>%
  count(CHR)

# plot number of SNPs per contig vs. mean depth ----
p11 <- left_join(temp, loc_stats_FIL_3) %>%
  ggplot() +
  geom_point(aes(x = n, y = `MEAN_DEPTH_BONNET_FIL-3`)) +
  labs(x = "number of SNPs per contig", y = "mean depth") +
  theme_standard

# plot depth vs SNP quality ----
site_qual <- read.table("results/BONNET_FIL-3.lqual", 
                        header = TRUE, stringsAsFactors = FALSE) %>%
  mutate(PROB = 10^(-QUAL/10))

temp <- data.frame(loc_stats_FIL_3$`MEAN_DEPTH_BONNET_FIL-3`, site_qual$QUAL) %>%
  rename(depth = loc_stats_FIL_3..MEAN_DEPTH_BONNET_FIL.3., qual = site_qual.QUAL)

p12 <- ggplot(temp, aes(x = depth, y = qual)) +
  geom_point(size = 1) +
  geom_vline(aes(xintercept = mean(depth, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_vline(aes(xintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = mean(qual, na.rm = TRUE)),
                 color = "red", linetype = "dashed", size = 1) +
  geom_hline(aes(yintercept = 20),
                 color = "darkblue", linetype = "dashed", size = 1) +
  labs(x = "mean depth per locus", y = "SNP quality") +
  theme_standard

m4 <- multiplot(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12, cols=2)

```

Data set contains r nrow(ind_stats_FIL_3)` individuals and `r nrow(loc_stats_FIL_3) loci.


## Run SNP counting script

```{bash, eval=FALSE, include=FALSE}

# run in BONNET folder

echo "FILTER SNP CONTIG INDV" > Filter.count

for i in *.vcf
do
  SNP=$(grep -cv '#' $i)
  CONTIG=$(grep -v '#' $i | cut -f 1 | sort | uniq | wc -l)
  INDV=$(vcfsamplenames $i | wc -l)
  echo "$i $SNP $CONTIG $INDV" >> Filter.count
done

```

Compare SNPs/contigs/indv at each filtering step and between filtering schemes.

```{r}

count <- read.table("data/BONNET/Filter.count", 
                    header = TRUE, stringsAsFactors = FALSE)